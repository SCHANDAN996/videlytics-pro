{% extends 'base.html' %}
{% block title %}My Wallet - Videlytics.pro{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white p-8 rounded-lg shadow-lg mb-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">My Wallet</h1>
        <p class="text-4xl font-bold text-green-600">₹{{ wallet.balance }}</p>
    </div>
    <div class="bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Add Funds to Wallet</h2>
        <div id="error-message" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-md"></div>
        <div class="flex items-center space-x-4">
            <input type="number" id="amount-input" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="Enter amount (e.g., 500)">
            <button id="pay-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700">Pay Now</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Minimum deposit: ₹1</p>
    </div>
    <div class="mt-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Transaction History</h2>
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <ul class="divide-y divide-gray-200">
                {% for tx in transactions %}
                <li class="px-6 py-4"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-indigo-600">Order ID: {{ tx.order_id }}</p><p class="text-sm text-gray-500">{{ tx.timestamp|date:"d M Y, h:i A" }}</p></div><div class="text-right"><p class="text-lg font-semibold {% if tx.status == 'Success' %}text-green-600{% elif tx.status == 'Failed' %}text-red-600{% else %}text-gray-600{% endif %}">{% if tx.status == 'Success' %}+{% endif %}₹{{ tx.amount }}</p><p class="text-sm font-medium {% if tx.status == 'Success' %}text-green-500{% elif tx.status == 'Failed' %}text-red-500{% else %}text-yellow-500{% endif %}">{{ tx.status }}</p></div></div></li>
                {% empty %}
                <li class="px-6 py-4 text-center text-gray-500">No transactions yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const payBtn = document.getElementById('pay-btn');
    const amountInput = document.getElementById('amount-input');
    const errorMessage = document.getElementById('error-message');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    payBtn.addEventListener('click', function() {
        const amount = amountInput.value;
        if (!amount || parseFloat(amount) < 1) { showError('Please enter an amount of at least ₹1.'); return; }
        hideError();

        fetch("{% url 'create_order' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ amount: amount })
        })
        .then(response => response.json())
        .then(order => {
            if (order.error) { showError(order.error); return; }
            const options = {
                "key": "{{ razorpay_key_id }}", "amount": order.amount, "currency": "INR",
                "name": "Videlytics.pro", "description": "Wallet Top-up", "order_id": order.id,
                "prefill": { "name": "{{ request.user.username }}", "email": "{{ request.user.email }}" },
                "theme": { "color": "#3399cc" }
            };
            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response){ alert("Payment Failed: " + response.error.description); });
            rzp1.open();
        })
        .catch(error => { console.error('Error:', error); showError('Could not create payment order. Please try again.'); });
    });
    function showError(message) { errorMessage.textContent = message; errorMessage.classList.remove('hidden'); }
    function hideError() { errorMessage.textContent = ''; errorMessage.classList.add('hidden'); }
});
</script>
{% endblock %}


